
// Header files
#include <LPC213x.H>                       /* LPC213x definitions */
#include <math.h>
#include <stdlib.h>
#include <string.h>
#include "lcd.h"
#include "rtwtypes.h"
#include "step1.h"
#include "step1_types.h"
#include "step2.h"
#include "step2_types.h"
#include "step3.h"
#include "step3_types.h"
#include "font5x8.h"
#include "graphic.h"
#include "KS0108.h"

// Macro declaration
#define MAX_VALUE 2000
#define AD_CR_CLKS10        (0x00000000)                  // Use 10-bit conversions
#define AD_CR_CLKS8         (0x00040000)                  // Use  8-bit conversions
#define AD_CR_PDN           (0x00200000)                  // Whether AD is operational (1) or powered-down (0)
#define AD_CR_CLKDIVSHIFT   (8)         
#define AD_CR_SEL1          (0x00000002)                  // Select channel 1
#define AD_CR_SEL2          (0x00000004)                  // Select channel 2
#define AD_CR_START_MASK    (0x07000000)                  
#define AD_CR_SELMASK       (0x000000ff)
#define AD_CR_START_NONE    (0x00000000)                  // No start (used when clearing PDN to 0)
#define AD_CR_START_NOW     (0x01000000)                  // Start conversion now
#define AD_DR_DONE          (0x80000000)                  // This bit is set to one when a conversion is complete
#define AD_DR_RESULTMASK    (0x0000ffc0)
#define AD_DR_RESULTSHIFT   (6)


// Global variable defination
uint16_T xaxis1,yaxis1,x1,x2,y1,y2;
double dec = 0;
double Y[26];
uint8_T char_bin[900];
uint8_T char_vec[10];
double char_vec1[10];
int32_T xyelem;	// = 770;

uint8_T xdata[MAX_VALUE],ydata[MAX_VALUE];

// Function declaration

extern void GLCD_SetPixel(unsigned char x, unsigned char y, unsigned char color);


static void emxInit_uint8_T(emxArray_uint8_T **pEmxArray, int32_T numDimensions)
{
  emxArray_uint8_T *emxArray;
  int32_T loop_ub;
  int32_T i;
  *pEmxArray = (emxArray_uint8_T *)malloc(sizeof(emxArray_uint8_T));
  emxArray = *pEmxArray;
  emxArray->data = (uint8_T *)NULL;
  emxArray->numDimensions = numDimensions;
  emxArray->size = (int32_T *)malloc((uint32_T)(sizeof(int32_T) * numDimensions));
  emxArray->allocatedSize = 0;
  emxArray->canFreeData = TRUE;
  loop_ub = numDimensions - 1;
  for (i = 0; i <= loop_ub; i++) {
    emxArray->size[i] = 0;
  }
}

static void emxFree_uint8_T(emxArray_uint8_T **pEmxArray)
{
  if (*pEmxArray != (emxArray_uint8_T *)NULL) {
    if ((*pEmxArray)->canFreeData) {
      free((void *)(*pEmxArray)->data);
    }

    free((void *)(*pEmxArray)->size);
    free((void *)*pEmxArray);
    *pEmxArray = (emxArray_uint8_T *)NULL;
  }
}
void InitADC()
{
	PCONP |= 0x00001000;
	PINSEL1 &= ~(0x00C00000);
	PINSEL1 &= ~(0x30000000);
	// Initialise ADC converter
  	AD0CR = AD_CR_CLKS8                   // 8-bit precision
         | AD_CR_PDN                      // Exit power-down mode
         | ((96 - 1) << AD_CR_CLKDIVSHIFT) // 4.213MHz Clock (14.7456*2MHz / 7)
         | AD_CR_SEL1 | AD_CR_SEL2;       // Use channel 1 and 2
}


uint16_T Read_xaxis()
{
	// Set P0.28 as AD0.1
	PINSEL1 &= ~(0x03000000);
	PINSEL1 |= 0x01000000;
	
	// Provide 3.3v with P0.29
	PINSEL1 &= ~(0x0C000000);
	IO0DIR |= (1<<29);
	IO0SET |= (1<<29);
	
	// Provide GND with P0.27
	IO0DIR |= (1<<27);
	IO0CLR |= (1<<27);
	
	// Set 0.30 'floating' (by setting it to input)
	IO0DIR &= ~(1<<30);
	
	delay(10);

	// Start AD conversion
  	AD0CR &= ~(AD_CR_START_MASK | AD_CR_SELMASK);
  	AD0CR |=  (AD_CR_START_NONE | AD_CR_SEL1);
  	AD0CR |=   AD_CR_START_NOW;	

	while (!(AD0DR1 & AD_DR_DONE));

	return ((AD0DR1 & AD_DR_RESULTMASK) >> AD_DR_RESULTSHIFT);

}

uint16_T Read_yaxis()
{
	// Set P0.29 as AD0.2
	PINSEL1 &= ~(0x0C000000);
	PINSEL1 |= 0x04000000;
	
	// Provide 3.3v with P0.28
	PINSEL1 &= ~(0x03000000);
	IO0DIR |= (1<<28);
	IO0SET |= (1<<28);
	
	// Provide GND with P0.30
	IO0DIR |= (1<<30);
	IO0CLR |= (1<<30);
	
	// Set 0.27 'floating' (by setting it to input)
	IO0DIR &= ~(1<<27);
	
	delay(10);

	// Start AD conversion
  	AD0CR &= ~(AD_CR_START_MASK | AD_CR_SELMASK);
  	AD0CR |=  (AD_CR_START_NONE | AD_CR_SEL2);
  	AD0CR |=   AD_CR_START_NOW;	

	while (!(AD0DR2 & AD_DR_DONE));

	return ((AD0DR2 & AD_DR_RESULTMASK) >> AD_DR_RESULTSHIFT);

}
// Dont forget to put ADC in power down mode after work is over

Init_UART()
{
	PINSEL0 |= 0x00000005;
	PINSEL0 &= ~(0x00000010);
	U0LCR = 0x83;
	U0DLL = 48;
	U0DLM = 0;
	U0LCR = 0x03;

}

void trans(char txdata)
{
	while (!(U0LSR & 0x20));	//transmit condition
	U0THR = txdata;
	delay(1);
}

void transmit()
{
	unsigned char  thou, hund, ten, one;
	unsigned char charac[10] = {'0','1','2','3','4','5','6','7','8','9'};
	uint16_T num,j;
	
for(j=0;j<xyelem;j++)
{
	num = xdata[j];	
	thou	= ( num )/1000;
	hund	= ( num - (thou*1000) )/100;
	ten		= ( num - (thou*1000) - (hund*100) )/10;
	one		= ( num - (thou*1000) - (hund*100) - (ten*10) );

	trans(charac[thou]);
	trans(charac[hund]);
	trans(charac[ten]);
	trans(charac[one]);
	trans('\r');
}

for(j=0;j<xyelem;j++)
{
	num = ydata[j] + 1000;	
	thou	= ( num )/1000;
	hund	= ( num - (thou*1000) )/100;
	ten		= ( num - (thou*1000) - (hund*100) )/10;
	one		= ( num - (thou*1000) - (hund*100) - (ten*10) );

	trans(charac[thou]);
	trans(charac[hund]);
	trans(charac[ten]);
	trans(charac[one]);
	trans('\r');
}

}

char character()
{
uint8_T j,ynum=0;
double ymax;
char letter[] = {'A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'};
// Finding minimum values ymin
ymax = Y[0];

	for(j=0;j<26;j++)
	{
		if(Y[j]>ymax)
		{
			ymax = Y[j];
			ynum = j;
		}
	}
return letter[ynum];
}

void transmit_char()
{
	unsigned char  ten, one;
	unsigned char charac[10] = {'0','1','2','3','4','5','6','7','8','9'};
	uint16_T num,j;
	
for(j=0;j<10;j++)
{
	num = char_vec[j];	
	ten		= ( num )/10;
	one		= ( num - (ten*10) );

	trans(charac[ten]);
	trans(charac[one]);
	trans('\r');
}
}

void remove_noise()
{
uint8_T xmin,ymin;
long j;

xmin = xdata[1];
ymin = ydata[1];

	for(j=0;j<xyelem-2;j++)
	{
		xdata[j] = xdata[j+1];		//xdata1
		ydata[j] = ydata[j+1];		//ydata1
		
		if(xdata[j]<xmin)			//xdata1
			xmin = xdata[j];		//xdata1
		if(ydata[j]<ymin)			//ydata1
			ymin = ydata[j];		//ydata1
	}

	for(j=0;j<xyelem-2;j++)
	{
		xdata[j] = xdata[j] - xmin;	//xdata1
		ydata[j] = ydata[j] - ymin;	//ydata1
	}
	xdata[xyelem-3] = 0;
	xdata[xyelem-2] = 0;
	ydata[xyelem-3] = 0;
	ydata[xyelem-2] = 0;
	xyelem = xyelem - 2;

// Finding minimum values xmin, ymin
xmin = xdata[0];
ymin = ydata[0];

	for(j=0;j<xyelem;j++)
	{
		if(xdata[j]<xmin)
			xmin = xdata[j];
		if(ydata[j]<ymin)
			ymin = ydata[j];
	}
// Extracting xaxis & yaxis with noise removal
	for(j=0;j<xyelem;j++)
	{
		xdata[j] = xdata[j] - xmin;
		ydata[j] = ydata[j] - ymin;
	}

}

double mapminmax(double input,int ymax,int ymin,int xmax,int xmin)
{
	double y;
	y= ((ymax-ymin)*(input-xmin)/(xmax-xmin))+ymin;
	return y;
}

void char_recog_nn(double x1[10], double Y[26])
{
double x[10];
double z[26],Z[26],sum,y[26];
int i,j;

int xmax[] = {58,49,59,41,56,67,30,60,45,62};
int xmin[] = {8,6,6,6,6,7,6,6,6,7};

int ymax = 1;
int ymin = 0;

double whi[26][10] = 
{
{1.3957949075991058,3.9340454132860971,-5.8733532926051542,2.76218031681339,-2.5167395656292202,1.0390053275710938,1.9308681062422937,15.464829277655532,-6.6909984651558734,-14.935844164066761},
{5.7421025780274668,-14.180484648371239,0.37260957059207717,-25.318174811913224,10.65193411074228,-28.509448192687575,13.798996959577376,-20.677484382860086,14.820896788139217,25.259088876998568},
{6.4396060213820512,-6.6651078744280028,-12.194377768243871,5.1272396000095704,9.3101872256287077,-12.262258227687401,9.1292874059207634,-8.0000945947544047,9.5217133740755546,11.802148588536822},
{-4.0120728911214245,6.4060545199176318,2.7981154792481231,2.0991182384059646,4.6805400114930489,4.856060264868046,8.9695129746932949,0.57646333948465689,0.90136950585211695,-2.9970900100162048},
{-20.99307019475367,-18.871448472251494,25.458447981821649,16.912048654134271,15.092394875274671,1.1412057854465711,-13.716368661045967,-14.978760792865298,5.0132523890856548,29.668017301859646},
{-7.7369113486246093,-11.571864318510809,2.0934168340006591,15.613230920992009,10.499194482390664,-1.2322054367087898,4.5719291253467,3.1633971078568224,-0.84780332353035115,2.6280070393610142},
{0.24167621195382169,6.0818954949153117,8.646300383660936,-6.5780867016290951,9.0089770478089513,-0.80612638620092258,-4.3265715784968162,-5.7468684361207769,6.0816464063613882,19.154044940661123},
{-0.29949284679482924,-7.1387960989303334,14.252730728523455,-6.0666524501165364,20.539591476523615,55.992615818517777,9.1501821269066017,-114.44140326908598,-13.966671103100675,81.832330561724831},
{7.0269101242519714,-3.7931401548702679,1.5186804848039124,-24.67947597532271,1.8579961065148587,0.20754831583227293,1.9216379497159028,1.8020318999365001,2.3732405438243505,-14.257261270049739},
{-22.110170490276392,38.343271656074805,-1.1256811078139681,-0.087715070354384167,-8.7171605061754516,5.9585396225282201,16.831943137882192,-0.37553158549383381,-5.163497812820605,-9.7869258481819976},
{20.845567949974519,-5.872897259262615,45.956392248937526,-8.5670055900832338,52.672184240825807,21.610769440720329,12.013424642739871,-21.387875484254597,1.2901412611349863,90.056694701712885},
{54.867009452416148,9.1826212414276185,32.738793836662985,35.848627411844127,-28.282518443333107,-47.461518490376633,27.778145900844329,4.9394918977870024,24.933114981612384,99.204343287925767},
{5.4694627904486559,3.424802321055644,18.292678315218332,2.8121120244044664,4.9340561074487184,33.792755426026197,-19.094819647278293,46.693859574955042,14.962975526130712,-51.839165615026751},
{0.13618254962810528,-4.4878816573736007,3.5358084085086086,0.23359313598711998,1.3190712348122033,-0.010471282180408617,1.3134685769105499,0.88591696920518825,1.3038699123471864,-0.40345688004931912},
{2.6010586621808196,-14.401795355512967,-10.59013004099279,15.779478185707639,-22.369686442907494,-0.96074104290953621,0.57186823150415023,17.667176300067585,18.565037613736891,-61.92740490076477},
{-18.190211525362574,196.89329617715842,30.744958458379497,-8.8104856719310369,4.5364855339694019,37.878100373080429,27.669249065820004,55.131605675460193,-68.513817890703734,100.70292653022399},
{-0.14654499701688009,-25.119574891093244,-5.0462757179761866,17.192383577261079,21.850781188368032,12.00929688011135,8.7434775052071725,-24.064577162168039,2.3695782864915009,11.039865081423482},
{6.5583533637782452,-7.0133168079010684,16.729757422133815,-11.808049663539476,-4.4348330320394833,7.5962619177325879,6.5619800476289223,-3.5262830056695704,-5.4841768408942446,3.8184007230379948},
{-17.378552042022417,5.4025991739209305,-17.769149050673033,16.8149029239862,2.5445785334849638,-9.3240955850178384,-8.4669053642840755,-2.483455664103615,1.7948006239837142,0.020274626532380075},
{10.007538888750723,-13.092956255229804,31.821897700420102,-31.335379299642057,-16.990987474153101,-48.784126958586981,0.35728132794065143,35.694422186790533,11.21670761824566,1.552238574429821},
{-16.724828852915959,-49.086550208890451,-36.610616140534177,3.7734215081192146,15.375528486372282,-29.479193968437684,-5.5431434743900265,-19.735721696792805,-8.5500475890044427,-9.5100510516766015},
{-6.9582321477049831,16.723542271628443,-9.6707867859673531,22.014002646387514,-17.657176611832757,17.712341691583323,-20.26325620530551,1.6554384668013531,19.818199942304808,-28.14094637226415},
{13.730304397013441,-2.4927174457552446,-7.9024234521788426,9.0475249559448265,-3.3579483360838149,0.6046101612256255,10.838539874863006,6.0199075418249635,6.9281163417873861,-13.580284205722368},
{2.6658131544946428,13.358064875516991,-31.898918512973388,-23.571832333657099,1.1721432160334475,-6.3344011337181474,11.578745802481665,0.46418747219887635,-5.6164018612763487,-25.546185397305674},
{-12.905010806829271,-0.72681041474132624,15.743712687187024,-4.0381872340231189,-3.0976003078926544,-9.5866101006754025,8.3198083500350801,0.28226809241854639,4.0278879297770525,1.2101311291222672},
{-63.545201550522108,20.178480229105237,11.226432785893376,-30.164888376208634,-14.597921213824909,-32.022831541866616,-32.898410663947239,17.821097423492617,6.5547133685799519,-36.690093801668318}
};

double woh[26][26] = 
{
{-2.6114759584546709e-007,-7.7876763447120493e-008,-3.2240994005230993e-008,-1.1300770599448626e-007,-2.772604034686103e-008,-5.4597628466883446e-008,6.1580877510591836e-009,2.6699534446273346e-007,-1.7390793850863517e-007,3.789644716172658e-007,6.2623756938134709e-008,2.2680669470371246e-008,5.676116702033282e-007,-3.321934248687651e-007,-1.2321331458354361e-008,-8.7754530250429364e-008,2.9987922124184028e-007,2.265813642388178e-007,3.6431739646530341e-007,2.6706158683902567e-007,1.838713904989738e-007,-5.8186126845014951e-007,1.327654867740371e-007,2.1775710709814423e-007,1.0000001611156055,-1.6748507977212735e-007},
{-1.0000122430675649,0.54904426447063936,-0.27453084622567536,-0.31373519585857196,-0.23530397859690924,0.1960820756189483,3.0309426408266454e-007,0.70589688103613757,0.23529151870272297,0.33333307448959681,-0.17646540441439038,-0.098048456563861741,0.98040734985482902,-1.0085320134791204e-005,-0.52940621369798557,0.27451418181077381,-0.019606477668711198,-0.37256549373314835,0.13725205306547619,0.70589825043531029,0.29411290883773217,-0.3529535295401281,0.15685501734120103,-0.058826266363613926,0.11765203012655115,-0.11765315596052738},
{-1.0000208407504996,0.70592896096678248,-1.3529855220534377,-0.11766234511865947,-0.58825195251032236,-0.17646473280520464,6.5151813206995788e-007,0.76472911381750275,0.58822920254900679,2.6618360113459968e-006,0.058833987540008188,-0.41178071430729546,0.11767282025073984,-1.9806574893931715e-005,0.17647962936811065,0.35294666248102685,0.11765059881599761,-0.76473020097022193,0.17646710002205707,0.76473249904569307,0.23528887029296783,0.11762654189794838,0.058813280800739456,-0.64706461851969121,0.29412497967742135,-0.29412701382384837},
{0.50000694524667755,-0.37256512231549094,0.18628775257572297,0.2843195568998847,0.088241266812130362,0.0098019008540181848,-1.5811878662887366e-007,0.23528512188630638,-0.088232975685659062,-0.3333337395921227,-0.058826886110584599,0.24510409462729382,-0.45099007770026922,6.6790534071527457e-006,0.32352558559856143,-0.18627726693509261,0.049017670856636199,0.4313839731006065,0.15686613017440143,-0.76471756177630101,-0.23529129882598934,-0.1176392758642693,0.60784957783623261,0.14705983272015596,-0.29411974464871199,0.2941216371341937},
{1.958930559098374e-006,-0.39216111713358892,0.19608231115548996,-0.49019435970683173,-0.11764574413822657,0.43137176129346139,2.9320051083961585e-008,0.35293916184921853,0.11764697036958753,0.33333263568632249,0.41176412444039362,-0.21568517019944189,0.15686040255133488,2.2572382409337632e-006,0.23529306177682907,-0.19607894648317734,0.15686186360987192,-0.019607178879842611,-0.098040176526695721,0.35293973835545978,-0.35294089223027109,-0.17646831173945207,-0.2549022751687659,0.47058922828377853,0.058822845261124884,-0.058822732296075771},
{0.50001228366016948,-0.72551889661057156,1.3627730635724531,0.34314564305299761,0.38236290543195089,-0.40196407744166995,-2.6100542863328113e-007,-0.64707427203088386,-0.38234834783314903,-0.33333485390659201,-0.58824197302111048,-0.049010076666776502,-0.50981965847647259,1.2476375080178919e-005,-0.26471235134846838,-0.3627480747658256,-0.0098062831115206302,0.31374152203366162,-0.4313691083075179,-0.64707556050026571,-0.35293761715310112,-0.17645742023507324,0.078437741034333611,-0.029409368652362069,0.058820168811350576,-0.058818543604816635},
{-0.50001328951673196,0.82355998274206732,-0.91179385754514242,0.029402363678523859,0.14704895850079705,-0.20587864109360968,6.3510764376617936e-008,0.058838749484950693,-0.14706154954087056,2.0914449148058088e-006,0.23529909139664426,-0.14706747429362732,0.47060490169274666,-1.2021399650704348e-005,0.20588825752220152,-0.088231772981607046,-0.029408982640486019,-0.058836373716447371,0.70588266113660614,0.05883781213485649,-0.05882680798184689,-0.52942600278478846,0.2352900322937633,-0.088238447554391558,0.17647673867371938,-0.17647642606414757},
{8.859051131435116e-006,-1.8435508296385893e-005,1.5586804514229713e-005,7.1227760410278501e-006,6.0138215930124563e-006,-3.3369181244612741e-006,-2.0465935829195456e-007,-8.4411372245248638e-006,2.4449777016981015e-006,-4.0485432328947933e-006,-4.9150462372422483e-006,6.5939035201366778e-006,-1.1806472075452576e-005,9.4206024844773651e-006,-3.6835452947125535e-006,-1.9564788528053866e-006,-2.7307776463542899e-006,1.0000070669401335,1.0000000986373592,-1.2550203762108125e-005,8.8749335258814241e-007,8.599726930529582e-006,4.5066096858780052e-006,1.6576643917586776e-006,-9.6508398232575447e-007,3.7549908113111756e-006},
{0.50000273299286391,-0.29412789471349321,0.14706681494705695,-0.61764395342491007,-0.088232150950133731,0.32352864628413314,0.99999929317872394,-0.23529902204049086,0.088235610860663796,7.9389996511883228e-007,0.058822428654079877,0.088238338820325848,0.11764275855708635,2.8223091725131909e-006,-0.32353184547196223,-0.14706075473375585,-0.38235394947473761,0.2353003505438383,0.17647218752878999,-0.23529962002037294,0.23529642398010914,0.11765080893612152,0.05882704448102781,-0.14705778115191301,0.29411622790867281,-0.29411572666286295},
{9.2628003719945872e-007,-1.31185265395267e-007,-1.3947399245515209e-007,1.0000008866347181,1.9469889561273297e-007,-4.5894846555582123e-007,-0.99999962811832521,2.7704735140695315e-007,-2.1424998834827164e-007,7.4735690368288207e-008,4.4659779918055254e-008,9.287480586228057e-008,-4.9213942263931673e-007,-3.0071390815186113e-008,4.5969591205145515e-007,-9.2859522248160654e-008,4.8970630460374025e-007,-2.5338815147322787e-007,-5.2815860281237601e-007,2.7705548424240235e-007,-7.298045808790172e-008,3.7343497454793473e-007,4.3637026365019264e-008,2.2552211046518007e-007,-6.8487629712775448e-007,6.8504645953269847e-007},
{-0.49999923149725195,0.3725451785941723,-0.18627066323835215,-0.28431375521840813,-0.088234620781458287,-0.009804038497910568,-4.5095464382394993e-008,-0.23529528082854118,0.088236850658409083,0.33333067072063288,0.058821436243031509,-0.24509706230850511,0.45097882487568758,2.4284623219892834e-006,-0.32353065768315925,0.18627526884233339,-0.049020994975163407,0.56862706247088191,0.84313737632824814,-0.23529727584275614,0.23529272466873735,0.11764769957691576,0.39215768321399119,-0.14705936423348218,0.29411957413529577,-0.29411800267665944},
{-0.50000412040085074,0.1764781358757688,-0.088241654503542585,-0.029415187940890819,-0.14706180127286272,0.20588393239789232,1.3715122815587168e-007,-0.058819442960365072,0.14705861319155092,-6.0598234966283888e-007,-0.23529273812978646,0.14705564922456005,0.52941650409849073,-3.0663481388581965e-006,-0.20588104570710578,0.088237088432525271,0.029411611016789858,0.05881821482513537,0.29411701197897466,-0.058819089955952995,0.058821366040607746,-0.47059222262760808,-0.2352960875303246,0.088233777303401553,-0.17646882949122961,0.17646888842279487},
{-1.0000220663968002,1.1961268162941079,-1.0980839045205217,-0.25491749156655374,-0.94119248466817651,-0.21568069207218751,2.2854057997845301e-007,0.82355558985682176,-0.058828517176352832,0.33333621851756651,0.29412675233564106,-0.39217191874459945,0.92159670192080667,-1.937856761917313e-005,-0.11763671413146086,0.098045474725382331,-0.078426770076247224,-0.49022045038238049,0.54901835848681668,0.82355608122735946,0.17646456770644417,-0.41178797755203889,-0.3725589747077877,-0.23529749726485155,0.47059680587209207,-0.47059850981588852},
{1.0000166581631571,-1.7059216193305027,1.352976110896116,0.11765865515929021,0.58824746029734132,0.17646738233078682,1.1065601607679006e-007,-0.76472798254833241,0.41176784782696457,-4.2253867250761104e-007,-0.058828340450763877,0.41177533116874798,-1.1176691056620089,1.3733619003714821e-005,-0.1764794160053009,-0.35294683896807177,-0.11765109954160215,-0.23527434221228494,-1.1764705769722044,-0.76472462685097253,-0.23528782766189943,0.88237281743942975,-0.058816281538522731,-0.35293967121373476,-0.29412641000619261,0.29412643325804677},
{2.4790894362224231e-006,-1.0000049628675109,1.0000048613120436,9.003394431893806e-007,1.2185511813916836e-006,-1.3771291070293316e-007,1.344148880101277e-007,-1.0000028262486513,9.8700155188191487e-008,-8.0827062054192077e-007,-1.0228553724974196e-006,9.8956925693755884e-007,-2.490308152982529e-006,1.7148145859142594e-006,-1.0000009274692603,8.7710048588779429e-009,-1.4129260196330895e-007,1.0532300927268998e-006,-1.3798567501431716e-006,-1.8483854940773164e-006,2.3529185352560351e-007,1.7737104666580244e-006,5.9814064540498529e-008,-5.3507560778528202e-008,-5.580391571754697e-007,7.6258157098470414e-007},
{9.4962593327422434e-006,-0.76473060712805907,-0.11762550777260518,0.29412399257384592,0.47059482085740367,-0.058825128861471558,2.2455979949279202e-007,-0.41177717745341119,0.52941509601241199,-3.2999533778111352e-006,0.35293774003022405,0.52941802783798453,-0.29413206086524668,9.7558210336059337e-006,0.058817792161791019,0.11764447463988241,-0.2941220771024593,0.41177350128411605,0.058822377182195781,-0.41177688368949394,0.41176683064133002,0.70589524996723607,0.35294525560356277,0.11764667732693837,-0.23529768115318261,0.23529932651905419},
{0.49999994512200829,-0.37254591054284808,0.18627125491569688,0.28431403701124097,0.088234930661242397,0.0098039075197693462,4.6304272349614672e-008,0.23529509658095404,-0.088236995176028538,-0.33333076494856917,-0.058821623534166999,0.24509737939593867,-0.45097933633045523,-2.5070744426803745e-006,0.32353076820819088,-0.18627559021507697,0.049021195891597188,-0.56862720085051677,-0.84313812900459839,0.23529709166693941,-0.23529288218544819,0.8823523167400481,-0.39215784821747407,0.14705951733477185,-0.29411972597333008,0.29411815359103799},
{0.50000034883215783,0.33333544743433008,-0.16666666443326525,0.16666718796634361,-0.49999824701792844,-0.16666758076912599,-2.797492642141469e-007,5.5765196896706769e-007,-0.50000029172079008,-0.33333079171410157,-4.9971062333246949e-007,-0.16666593085915021,-0.33333171407824236,-8.16399030679979e-007,0.50000105117931959,0.16666637886878391,0.16666925705815039,-0.33333091124138287,-0.66666454136454012,9.2300868130060345e-007,8.6122422157080872e-007,-1.69632325510764e-006,-0.33333342440611746,-0.49999720339138631,-1.5283435951671595e-006,-5.7264342047309394e-007},
{-9.8293550640282239e-007,1.0000008296439562,-1.0000005637394058,-5.4969205859685223e-007,-4.5747565333774502e-007,2.9375236121357929e-007,-1.4610747683172344e-007,1.1475261325842511e-006,-2.6827993552192497e-007,3.5919845344264342e-007,5.6863225113732833e-007,-5.9263780524447221e-007,1.2093085790844906e-006,-1.2278680006681494e-006,5.8700715832420819e-007,1.506377094963166e-008,2.507411788858212e-007,-6.7898276861199988e-007,1.8629397955498328e-007,1.0257818249519457e-006,-3.2166030955628142e-007,-1.0280072482860737e-006,-1.9315706154310069e-007,8.8204826010530941e-008,1.8637324641610088e-008,-2.5537797197633713e-007},
{2.0257739051466898e-007,1.4949779467322586e-008,7.9186651362882451e-009,-0.9999999505941175,6.5715752181390231e-009,-1.6083367459968173e-009,1.8367812561068766e-007,-8.3713153766409495e-009,-2.1950113492368865e-008,-9.2544653073358768e-009,-1.3971164419562152e-008,-1.8760842214465329e-008,1.4842618995197605e-008,-2.9852125828640472e-008,-1.3394560846413251e-008,-1.7611131047904038e-008,-8.7458827102165988e-009,4.9079877701270903e-008,3.7198009409895039e-008,-8.3663981674191041e-009,-9.382511891804619e-009,-3.3256968328901657e-008,9.3179790814457725e-010,-3.7094935417970927e-009,2.7343937645034402e-008,-2.6861506404459106e-008},
{0.50000161018578226,0.33333481671748971,-0.166665894160857,0.16666757273687316,0.50000115460188754,-0.16666761575542804,-2.7645561800114557e-007,-1.167572400378558e-007,-0.50000030179665755,-0.33333114940198266,-7.7033766085836782e-007,-0.16666555495580471,-0.33333297194157641,-3.8123813701068406e-007,0.50000113489310449,0.16666628424876737,0.16666925726782544,-0.33333054194282413,-0.66666537040166085,1.3216921983287354e-007,7.9704297405305347e-007,-7.5884737091051885e-007,-0.33333348088223208,0.50000193182057795,-1.6332998246453505e-006,-2.261597316487512e-007},
{6.0321913958545714e-006,-0.47060112741249371,0.23530694229381049,0.41176844684117525,0.058828058268934967,0.11764554146879973,-8.3893034794152773e-008,-0.17647717959483303,-0.058821158587821915,-1.9168506549897133e-006,0.29411476337427062,-0.058819389406363491,-0.41177267530468831,6.3199889646622703e-006,-0.11764969163302008,-0.23529526172957682,-0.41176629558740191,0.1764762605425351,-0.1176467777197736,-0.17647813125287951,0.17647134629302155,0.58824215754055165,0.29411972299187422,-0.23529305670215805,-0.52941267772176648,0.5294142718189967},
{0.50001398442161782,-0.45101265695118054,0.22552064117000639,0.1862848726586489,0.26471663114155058,-0.30392543114876891,-2.5375486779500043e-007,-0.29413298570678631,-0.2647018102616191,0.33332982438763836,-0.17647780187634929,0.40197163757022952,-0.01962635008176554,1.4278722931332285e-005,-0.029417801667703011,-0.22549385064024965,0.48038840865300414,0.62746567986234791,0.13725576394924163,-0.29413593889732786,0.29412101997257045,-0.35292642461885559,0.15686918460316712,0.44117965733708603,0.11764238086988198,-0.11764063084677838},
{-0.50000975277934268,0.76473120379698245,-0.38237495851090136,-0.79412480501779203,0.029403895390438365,0.55882604663158197,-1.481635052335547e-008,0.41177679810751927,-0.029414324315879471,1.5968133261118456e-006,-0.35293679104679976,-0.02941963476256414,0.29413138377566733,-9.5514219654054447e-006,0.44118139619278413,0.3823563264983636,-0.20587957252699071,-0.4117766810046371,-0.058824363213359952,0.41177825246521416,-0.41176845514443128,-0.70589384129213173,-0.35294688689865056,0.38235132639406394,-0.76470279153786958,-0.23529906922587171},
{0.49999811759980911,0.29412314631447312,-0.14706529887063,0.6176463394762739,0.088233842263159598,-0.32352947644625152,-3.3040847118394863e-008,0.23529637813397386,-0.088237309896752089,2.0657407910542464e-006,-0.05882212495636966,-0.088236276885888629,-0.11764446864647897,-2.8432933996461039e-006,0.32353088015264253,0.1470583647688537,0.38235447505068321,-0.23529484934043418,-0.17647075312392166,0.23529697670360902,-0.23529288774966783,-0.11764934212328799,-0.058823878453819499,0.14705916601058922,-0.29411866909204598,0.29411710008305297},
{2.0788861676743382e-007,-2.3822448236024076e-007,1.0000001597277446,1.2934119912964922e-007,1.0726762904675115e-007,-8.3474658433059889e-008,-2.7270110292377914e-008,-4.0429610628126041e-007,6.530381638702069e-009,-3.5478638884332606e-008,-9.4468700561466874e-008,1.1367919300666131e-007,-2.31333401189409e-007,1.9061512820799122e-007,-2.2967999208066819e-007,-1.699499809526481e-008,4.9741908098706238e-009,1.9615044839170843e-007,-1.6499269887461794e-009,-2.3136926043255929e-007,4.9598622313208853e-008,1.0770312136780842e-007,4.7002801674660082e-008,2.8584839844659865e-008,-5.9165791601900234e-008,4.6059167458354594e-008}
};

double hb[26] = 
{-10.963742126402792,
-41.458618374917343,
-24.066246350222453,
20.183549858771041,
-18.754157503819478,
13.123252510693735,
29.329338179372414,
-103.77142708822956,
-16.473194191509801,
0.58235784525252199,
23.504543110389982,
65.848976348241393,
14.404225038197531,
-3.8158254655901969,
6.8565261733408214,
124.88190007851867,
-8.5494757441560658,
-15.76235039859651,
20.41677513377844,
44.396532236484767,
-59.738473562976999,
-21.026521959467559,
12.019667708120398,
8.5776982624670914,
-16.174041436589214,
-37.898378157478085,
};

double ob[26] = 
{-1.0007956940962344e-006,
-1.4706160348925121,
-2.1765222923901719,
-1.3235117456455443,
-1.2352893324003358,
0.26474021244679063,
-2.2059143554000151,
-0.99997885140399589,
-0.67646308709918912,
-1.000000379731329,
-0.676466348450946,
-1.7941265302406755,
-1.8824069622789887,
1.1765114128556646,
-0.99999473839505304,
-1.0587973000060096,
-0.32353316437797169,
-0.50000151913673641,
-1.000002836637258,
-2.7663170509329999e-008,
-0.49999882715749872,
-0.88233506766045544,
-0.97055199963266103,
-2.441202577827509,
-1.3235370045404642,
3.5846172823593437e-007,
};

// Mapping minmax to input
for(i=0;i<10;i++)
{
	x[i]=mapminmax(x1[i],1,-1,xmax[i],xmin[i]);
}

// Calculating output (at hidden layer)
for(j=0;j<26;j++)
{
	z[j]=0;
	for(i=0;i<10;i++)
	{
		z[j]=z[j]+ x[i]*whi[j][i];
	}
	z[j]=z[j]+hb[j];
}

// Applying Activation function at hidden neurons
for(j=0;j<26;j++)
{
	Z[j]=tanh(z[j]);
}

// Calculating output (at output layer)
for(j=0;j<26;j++)
{
	sum=0;
	for(i=0;i<26;i++)
	{
		sum=sum+(Z[i]*woh[j][i]);
	}
	y[j]=sum+ob[j];


// Mapping minmax to output
	Y[j]=mapminmax(y[j],ymax,ymin,1,-1);
}

}

capture()
{
	xaxis1 = Read_xaxis();
	yaxis1 = Read_yaxis();

	if(xaxis1<10)
	xaxis1 = 0;
	if(yaxis1<10)
	yaxis1 = 0;

	delay(1000);
}

delay_ms(int ticks)
{
unsigned long ms = 12037*ticks;
while(ms--)
{
__asm volatile("nop");
}
}

// Main function
int main (void) 
{  
// Local variable definations
emxArray_uint8_T *xaxis;
emxArray_uint8_T *yaxis;
emxArray_uint8_T *norm_xaxis_filt;
emxArray_uint8_T *norm_yaxis_filt;

uint16_T count;
uint8_T xaxis2,yaxis2;

long j = 0;

int again = 1;

char letter;
char letterstr[10];
int i=0;
letterstr[i] = '\0';

// Variable Initialisation
	for(j=0;j<MAX_VALUE;j++)
	{
		xdata[j] = 0;
		ydata[j] = 0;
	}

	
// Function Initialisation
	PINSEL2 &= ~((1<<2)|(1<<3));
	GLCD_Initalize();				  //Initialize the LCD
	Init_UART();
	InitADC();

// Welcome message
	GLCD_ClearScreen();
	GLCD_GoTo(10,4);	
	GLCD_WriteString("Intelligent e-book");
//	for(j=0;j<999999;j++);
	delay_ms(2000);

// Calibration
	//Left bottom
	GLCD_ClearScreen();
	GLCD_GoTo(10,0);	
	GLCD_WriteString("Calibration");
	GLCD_GoTo(10,4);	
	GLCD_WriteString("Touch the point");
	GLCD_GoTo(0,7);	
	GLCD_WriteString("o");

	do
	{
	xaxis1 = Read_xaxis();
	yaxis1 = Read_yaxis();

	if(xaxis1<10)
		xaxis1 = 0;
	if(yaxis1<10)
		yaxis1 = 0;
	}while(xaxis1==0 && yaxis1==0);
	for(j=0;j<25;j++)
	capture();


	x1 = xaxis1;
	y1 = yaxis1;

	GLCD_GoTo(10,5);	
	GLCD_WriteString("Stored");
	delay_ms(1000);

	//Right top
	GLCD_ClearScreen();
	GLCD_GoTo(10,0);	
	GLCD_WriteString("Calibration");
	GLCD_GoTo(10,4);	
	GLCD_WriteString("Touch the point");
	GLCD_GoTo(120,0);	
	GLCD_WriteString("o");

	do
	{
	xaxis1 = Read_xaxis();
	yaxis1 = Read_yaxis();

	if(xaxis1<10)
		xaxis1 = 0;
	if(yaxis1<10)
		yaxis1 = 0;
	}while(xaxis1==0 && yaxis1==0);
	for(j=0;j<25;j++)
	capture();

	x2 = xaxis1;
	y2 = yaxis1;

	GLCD_GoTo(10,5);	
	GLCD_WriteString("Stored");
	delay_ms(1000);


while(again==1)
{
again = 0;

// Capturing xaxis and yaxis

GLCD_ClearScreen();
GLCD_GoTo(10,0);	
GLCD_WriteString("Intelligent e-book");
GLCD_GoTo(12,4);		
GLCD_WriteString("Waiting for input");
do
{
xaxis1 = Read_xaxis();
yaxis1 = Read_yaxis();

if(xaxis1<10)
	xaxis1 = 0;
if(yaxis1<10)
	yaxis1 = 0;

}while(xaxis1==0 && yaxis1==0);

xyelem = 0;
count = 0;
GLCD_ClearScreen();
GLCD_GoTo(0,0);		

// Eliminate first 25 samples
	for(j=0;j<25;j++)
	capture();

while(count!=250)
{
	capture();

	if(xaxis1!=0 && yaxis1!=0 && count==0)
	{
		
//	xaxis2 = (uint8_T)(((xaxis1-80)*255)/730);
//	yaxis2 = (uint8_T)(((yaxis1-100)*255)/650);
	xaxis2 = (uint8_T)(((xaxis1-x1)*255)/(x2-x1));
	yaxis2 = (uint8_T)(((yaxis1-y1)*255)/(y2-y1));

		count = 0;
	  	xdata[xyelem] = xaxis2;
		ydata[xyelem] = yaxis2;
		xyelem = xyelem + 1;
		GLCD_SetPixel(xaxis2/2,255-(yaxis2/4),1);

		if(xyelem>MAX_VALUE - 1)
		{
			GLCD_ClearScreen();
			GLCD_GoTo(10,0);	
			GLCD_WriteString("Intelligent e-book");
			GLCD_GoTo(10,4);		
			GLCD_WriteString("Overflow!!!");
			while(1);
		}
	}
	else if(xaxis1!=0 && yaxis1!=0)
	{
		xyelem = xyelem - 2;
		// Eliminate first 25 samples
		for(j=0;j<25;j++)
		capture();
		count = 0;
	}
	else
	{
	 	count = count + 1;
	}

//	delay(1000);
}
GLCD_ClearScreen();
GLCD_GoTo(10,0);	
GLCD_WriteString("Intelligent e-book");
GLCD_GoTo(0,1);	
GLCD_WriteString(letterstr);

//GLCD_GoTo(10,4);		
//GLCD_WriteString("Scanning ended");
//delay_ms(500);


// Transmitting data to PC
//	transmit();

// Remove noise
	remove_noise();

// Allocating space for pointers  
	xaxis = emxCreateWrapper_uint8_T(xdata,1,xyelem);	//xdata1
	yaxis = emxCreateWrapper_uint8_T(ydata,1,xyelem);	//ydata1
	emxInit_uint8_T(&norm_xaxis_filt, 2);
	emxInit_uint8_T(&norm_yaxis_filt, 2);

/*	GLCD_ClearScreen();
	GLCD_GoTo(10,0);	
	GLCD_WriteString("Intelligent e-book");
	GLCD_GoTo(0,2);		
	GLCD_WriteString("Step1");
	GLCD_GoTo(37,2);		
	GLCD_WriteString("In");
*/
//	for(j=0;j<999999;j++);

	step1(xaxis, yaxis, norm_xaxis_filt, norm_yaxis_filt);

//	GLCD_ClearScreen();
//	GLCD_GoTo(10,0);	
//	GLCD_WriteString("Intelligent e-book");
//	GLCD_GoTo(54,2);	
//	GLCD_WriteString("Out");
//	for(j=0;j<999999;j++);

	emxDestroyArray_uint8_T(xaxis);
	emxDestroyArray_uint8_T(yaxis);
	
//	GLCD_ClearScreen();
//	GLCD_GoTo(10,0);	
//	GLCD_WriteString("Intelligent e-book");
//	GLCD_GoTo(0,3);	
//	GLCD_WriteString("Step2");
//	GLCD_GoTo(37,3);		
//	GLCD_WriteString("In");
//	for(j=0;j<999999;j++);

// char_bin is stored in column first fashion... each column vector are concatenated	
	step2(norm_xaxis_filt, norm_yaxis_filt, char_bin);

//	GLCD_ClearScreen();
//	GLCD_GoTo(10,0);	
//	GLCD_WriteString("Intelligent e-book");
//	GLCD_GoTo(54,3);	
//	GLCD_WriteString("Out");
//	for(j=0;j<999999;j++);
	
	emxFree_uint8_T(&norm_xaxis_filt);
	emxFree_uint8_T(&norm_yaxis_filt);

//	GLCD_ClearScreen();
//	GLCD_GoTo(10,0);	
//	GLCD_WriteString("Intelligent e-book");
//	GLCD_GoTo(0,4);	
//	GLCD_WriteString("Step3");
//	GLCD_GoTo(37,4);		
//	GLCD_WriteString("In");
//	for(j=0;j<999999;j++);

	for(j=0;j<10;j++)
	char_vec[j] = 1;
	
	step3(char_bin, char_vec);
	
//	GLCD_ClearScreen();
//	GLCD_GoTo(10,0);	
//	GLCD_WriteString("Intelligent e-book");
//	GLCD_GoTo(54,4);	
//	GLCD_WriteString("Out");
//	for(j=0;j<999999;j++);
  

	for(j=0;j<26;j++)
	char_vec1[j] = char_vec[j];
	
	// Feeding char_vec to trained neural network
	char_recog_nn(char_vec1,Y);

	letter = character();

	letterstr[i] = letter;
	letterstr[i+1] = '\0';

//	GLCD_ClearScreen();
//	GLCD_GoTo(10,0);	
//	GLCD_WriteString("Intelligent e-book");
//	GLCD_GoTo(0,6);	
//	GLCD_WriteString("Letter is: ");
	GLCD_GoTo(0,1);	
	GLCD_WriteString(letterstr);
	GLCD_GoTo(0,7);	
	GLCD_WriteString("Continue");

	do
	{
	xaxis1 = Read_xaxis();
	yaxis1 = Read_yaxis();

	if(xaxis1<10)
		xaxis1 = 0;
	if(yaxis1<10)
		yaxis1 = 0;

	}while(xaxis1==0 && yaxis1==0);

again = 1;
i = i + 1;
/*
GLCD_ClearScreen();
GLCD_GoTo(10,0);	
GLCD_WriteString("Intelligent e-book");
GLCD_GoTo(20,4);		
GLCD_WriteString("Restarting.");
delay_ms(200);
GLCD_WriteString(".");
delay_ms(200);
GLCD_WriteString(".");
delay_ms(200);
GLCD_WriteString(".");
*/
delay_ms(400);
}

  while(1); 
}
